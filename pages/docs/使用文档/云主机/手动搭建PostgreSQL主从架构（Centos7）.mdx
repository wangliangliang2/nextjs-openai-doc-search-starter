<div><main role="main">         <article role="article" aria-labelledby="title_6t5_3o8_8dr"> <div>               <p class="shortdesc">PostgreSQL被业界誉为最先进的开源数据库。目前七牛云数据库PostgreSQL版具有NoSQL兼容、高效查询、插件化管理、安全稳定的特性。本文档介绍在CentOS 7操作系统的QVM实例上搭建PostgreSQL主从架构的操作步骤。
               </p>               <div>                  <div>                     <h1 font-weigh = "bold">前提条件</h1>                  </div>                  <ul class="ul" id="ul-eyr-gl9-66f">                     <li>已注册七牛云账号。如还未注册，请先完成<span><a href="https://portal.qiniu.com/signup?ref=developer.qiniu.comregister.htm?" target="_blank">账号注册</a></span>。
                     </li>                     <li>已在安全组入方向中添加规则放行5432端口</span>。
                     </li>                  </ul>               </div>               <section class="section context" id="context-iw1-5fs-txh">                  <div>                     <h1 font-weigh = "bold">背景信息</h1>                  </div>                  <p class="p" id="p-pd8-u0a-7i2">本教程适用于熟悉七牛云服务器QVM、Linux系统、PostgreSQL的七牛云用户。</p>                  <div>本教程在示例步骤中使用了以下实例配置和软件版本。操作时，请您以实际软件版本为准。 
                     <ul class="ul" id="ul-y6t-iz9-omp">                        <li>实例规格：ecs.g6.large</li>                        <li>操作系统：CentOS 7.2 </li>                        <li>PostgreSQL：9.5</li>                     </ul>                  </div>                  <div>在七牛云服务器QVM上安装PostgreSQL有以下方式： 
                     <ul class="ul" id="ul-yd3-xd3-c95">    <li>手动部署（源码编译安装/yum安装）</li>                     </ul>                  </div>                  <p class="p" id="p-ajk-zi7-uao">本教程基于yum方式手动安装并搭建PostgreSQL主从复制架构。</p>               </section>               <section class="section" id="section-pav-wid-h44">                  <h1 font-weigh = "bold">步骤一：选购QVM实例</h1>                  <div>搭建PostgreSQL主从复制架构，需要选购2台专有网络类型的QVM实例，一台QVM实例作为主节点，另一台QVM实例作为从节点</span>。 
                     <div>                        <div><i class="icon-note note"></i></div>                        <div><strong>说明</strong> 建议您不为QVM实例分配公网IP，按需购买弹性公网IP绑定至QVM实例，后续您可以根据实际情况考虑升级配置或调优架构</span>。
                        </div>                     </div>                  </div>               </section>               <section class="section" id="section-qgn-13v-8op">                  <h1 font-weigh = "bold">步骤二：配置PostgreSQL主节点</h1>                  <ol class="ol steps" id="steps-ijr-40v-bvq">                     <li><span>依次运行以下命令安装PostgreSQL。</span><div><pre><code>yum update -y</code></pre><pre><code>wget https://download.postgresql.org/pub/repos/yum/reporpms/EL-7-x86_64/pgdg-redhat-repo-latest.noarch.rpm</code></pre><pre><code>rpm -ivh pgdg-redhat-repo-latest.noarch.rpm</code></pre><pre><code>yum install postgresql95-server postgresql95-contrib -y</code></pre><pre><code>/usr/pgsql-9.5/bin/postgresql95-setup initdb</code></pre><div>                              <div><i class="icon-note note"></i></div>                              <div><strong>说明</strong> 本教程以<span>PostgreSQL 9.5</span>版本为例。实际安装时，请您使用最新版本。
                              </div>                           </div>                        </div>                     </li>                     <li><span>依次运行以下命令启动服务并设置服务开机自启动。</span><div><pre><code>systemctl start postgresql-9.5.service    #启动服务</code></pre><pre><code>systemctl enable postgresql-9.5.service   #设置服务开机自启动</code></pre></div>                     </li>                     <li><span>在主节点上创建数据库账号replica（用于主从复制），并设置密码及登录权限和备份权限。 </span><ol type="a" class="ol substeps" id="substeps-tgr-c0y-3wi">                           <li><span>运行以下命令登录postgres用户。 </span><div><pre><code>su - postgres</code></pre></div>                           </li>                           <li><span>输入<code>psql</code>进入PostgreSQL交互终端。 </span><div><pre><code>-bash-4.2$ psql</code></pre></div>                           </li>                           <li><span>为用户<code>postgres</code>设置密码，增强安全性。</span><div><pre><code>postgres=# ALTER USER postgres WITH PASSWORD 'YourPassWord';</code></pre></div>                           </li>                           <li><span>输入以下SQL语句创建数据库账号replica，并设置密码及登录权限和备份权限。 </span><div>本示例中将密码设置为<code>replica</code>。 <pre><code>postgres=# CREATE ROLE replica login replication encrypted password 'replica';</code></pre></div>                           </li>                           <li><span>查询账号是否创建成功。 </span><div><pre><code>postgres=# SELECT usename from pg_user;</code></pre></div>                              <div>                                 <div>返回结果如下，表示已创建成功。 <pre><code>usename  
----------
postgres
replica
(2 rows)</code></pre></div>                              </div>                           </li>                           <li><span>查询权限是否创建成功。</span><div><pre><code>postgres=# SELECT rolname from pg_roles;</code></pre></div>                              <div>                                 <div>返回结果如下，表示已创建成功。 <pre><code>rolname  
----------
postgres
replica
(2 rows)</code></pre></div>                              </div>                           </li>                           <li><span>输入<code>\q</code>后，按<code>Enter</code>键退出SQL终端。</span><div><pre><code>postgres=# \q</code></pre></div>                           </li>                           <li><span>输入<code>exit</code>后，按<code>Enter</code>键退出PostgreSQL。 </span><div><pre><code>-bash-4.2$ exit
logout</code></pre></div>                           </li>                        </ol>                     </li>                     <li><span>运行以下命令打开<span>pg_hba.conf</span>文件，设置replica用户白名单。 </span><div><pre><code>vim /var/lib/pgsql/9.5/data/pg_hba.conf</code></pre><div>在<code>IPv4 local connections</code>段添加下面两行内容。 <pre><code>host    all             all             &lt;从节点的VPC IPv4网段&gt;          md5     #允许VPC网段中md5密码认证连接
host    replication     replica         &lt;从节点的VPC IPv4网段&gt;          md5     #允许用户从replication数据库进行数据同步</code></pre></div>                           <p class="p" id="p-c0m-sx1-vxn">添加完成后，按<kbd>esc</kbd>键，输入<code>:wq</code>并按下<kbd>enter</kbd>键，保存并退出。
                           </p>                        </div>                     </li>                     <li><span>运行以下命令打开<span>postgresql.conf</span>文件。 </span><div><pre><code>vim /var/lib/pgsql/9.5/data/postgresql.conf</code></pre><div>分别找到以下参数，并将参数修改为以下内容： <pre><code>listen_addresses = '*'   #监听的IP地址
wal_level = hot_standby  #启用热备模式
synchronous_commit = on  #开启同步复制
max_wal_senders = 32     #同步最大的进程数量
wal_sender_timeout = 60s #流复制主机发送数据的超时时间
max_connections = 100    #最大连接数，从库的max_connections必须要大于主库的</code></pre></div>                           <p class="p" id="p-iwa-2p9-7li">修改完成后，按<kbd>esc</kbd>键，输入<code>:wq</code>并按下<kbd>enter</kbd>键，保存并退出。
                           </p>                        </div>                     </li>                     <li><span>运行以下命令重启服务。</span><div><pre><code>systemctl restart postgresql-9.5.service</code></pre></div>                     </li>                  </ol>               </section>               <section class="section" id="section-o5u-jgk-048">                  <h1 font-weigh = "bold">步骤三：配置PostgreSQL从节点</h1>                  <ol class="ol steps" id="steps-mi7-cpi-bh6">                     <li><span>依次运行以下命令安装PostgreSQL。 </span><div><pre><code>yum update -y</code></pre><pre><code>wget https://download.postgresql.org/pub/repos/yum/reporpms/EL-7-x86_64/pgdg-redhat-repo-latest.noarch.rpm</code></pre><pre><code>yum install postgresql95-server postgresql95-contrib -y</code></pre></div>                     </li>                     <li><span>运行以下命令使用pg_basebackup基础备份工具指定备份目录。 </span><div><pre><code>pg_basebackup -D /var/lib/pgsql/9.5/data -h &lt;主节点IP&gt; -p 5432 -U replica -X stream -P</code></pre>本示例中<code>Password</code>为<code>replica</code>。 <pre><code>Password: 
30075/30075 kB (100%), 1/1 tablespace</code></pre></div>                     </li>                     <li><span>依次运行以下命令新建并修改<span>recovery.conf</span>配置文件。</span><div><pre><code>cp /usr/pgsql-9.5/share/recovery.conf.sample /var/lib/pgsql/9.5/data/recovery.conf</code></pre><pre><code>vim /var/lib/pgsql/9.5/data/recovery.conf</code></pre><div>分别找到以下参数，并将参数修改为以下内容： <pre><code>standby_mode = on     #声明此节点为从库
primary_conninfo = ‘host=&lt;主节点IP&gt; port=5432 user=replica password=replica’ #对应主库的连接信息
recovery_target_timeline = ‘latest’ #流复制同步到最新的数据</code></pre></div>                           <p class="p" id="p-3uh-tm9-vy8">修改完成后，按<kbd>esc</kbd>键，输入<code>:wq</code>并按下<kbd>enter</kbd>键，保存并退出。
                           </p>                        </div>                     </li>                     <li><span>运行以下命令打开<span>postgresql.conf</span>文件。 </span><div><pre><code>vim /var/lib/pgsql/9.5/data/postgresql.conf</code></pre><div>分别找到以下参数，并将参数修改为以下内容： <pre><code>max_connections = 1000             # 最大连接数，从节点需设置比主节点大
hot_standby = on                   # 开启热备
max_standby_streaming_delay = 30s  # 数据流备份的最大延迟时间
wal_receiver_status_interval = 1s  # 从节点向主节点报告自身状态的最长间隔时间
hot_standby_feedback = on          # 如果有错误的数据复制向主进行反馈</code></pre></div>                           <p class="p" id="p-gr7-nst-qz3">修改完成后，按<kbd>esc</kbd>键，输入<code>:wq</code>并按下<kbd>enter</kbd>键，保存并退出。
                           </p>                        </div>                     </li>                     <li><span>运行以下命令修改数据目录的属组和属主。 </span><div><pre><code>chown -R postgres.postgres /var/lib/pgsql/9.5/data</code></pre></div>                     </li>                     <li><span>依次运行以下命令启动服务并设置服务开机自启动。</span><div><pre><code>systemctl start postgresql-9.5.service    #启动服务</code></pre><pre><code>systemctl enable postgresql-9.5.service   #设置服务开机自启动</code></pre></div>                     </li>                  </ol>               </section>               <section class="section" id="section-rk4-uqg-m71">                  <h1 font-weigh = "bold">步骤四：检测验证</h1>                  <p class="p" id="p-60a-g8f-ta4">检测验证需要主从节点之间存在数据交互，例如，从节点备份目录时，进行检测能够得到预期的结果。</p><pre><code>pg_basebackup -D /var/lib/pgsql/9.5/data -h &lt;主节点IP&gt; -p 5432 -U replica -X stream -P</code></pre><ol class="ol steps" id="steps-o1n-czn-1cc">                     <li><span>在主节点中运行以下命令查看sender进程。 </span><div><pre><code>ps aux |grep sender</code></pre></div>                        <div>                           <div>返回结果如下，表示可成功查看到sender进程。 <pre><code>postgres  2916  0.0  0.3 340388  3220 ?        Ss   15:38   0:00 postgres: wal sender     process replica 192.168.**.**(49640) streaming 0/F01C1A8</code></pre></div>                        </div>                     </li>                     <li><span>在从节点中运行以下命令查看receiver进程。</span><div><pre><code>ps aux |grep receiver</code></pre></div>                        <div>                           <div>返回结果如下，表示可成功查看到receiver进程。 <pre><code>postgres 23284  0.0  0.3 387100  3444 ?        Ss   16:04   0:00 postgres: wal receiver process   streaming 0/F01C1A8</code></pre></div>                        </div>                     </li>                     <li><span>在主节点中进入PostgreSQL交互终端，输入以下SQL语句，在主库中查看从库状态。 </span><div><pre><code>postgres=# select * from pg_stat_replication;</code></pre></div>                        <div>                           <div>返回结果如下，表示可成功查看到从库状态。 <pre><code>pid | usesysid | usename | application_name | client_addr | client_hostname | client_port | backend_start | backend_xmin | state | sent_location | write_locati
on | flush_location | replay_location | sync_priority | sync_state 
------+----------+---------+------------------+---------------+-----------------+------------- +-------------------------------+--------------+-----------+---------------+-------------
---+----------------+-----------------+---------------+------------
2916 | 16393 | replica | walreceiver | 192.168.**.** | | 49640 | 2017-05-02 15:38:06.188988+08 | 1836 | streaming | 0/F01C0C8 | 0/F01C0C8 
| 0/F01C0C8 | 0/F01C0C8 | 0 | async
(1 rows)</code></pre></div>                        </div>                     </li>                  </ol>               </section>            </div>         </article>      </main>   


</div>  </div>  	