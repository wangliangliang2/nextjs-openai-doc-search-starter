<div> <main role="main"> <article role="article" aria-labelledby="title_ok8_5o0_utd"> <div> <p class="shortdesc">vsftpd（very secure FTP daemon）是Linux下的一款小巧轻快、安全易用的FTP服务器软件。本教程介绍如何在Linux实例上安装并配置vsftpd。</p> <div> <div> <h1 font-weigh = "bold">前提条件</h1> </div> <ul class="ul" id="ul-lmj-n2c-uoj"> <li>已注册七牛云账号。如还未注册，请先完成<a href="https://portal.qiniu.com/signup?ref=developer.qiniu.comregister.htm?" target="_blank">账号注册</a>。 </li> <li>已完成实名认证。 </li> <li>已创建QVM实例并为实例分配了公网IP地址。 </li> </ul> </div> <section class="section context" id="context-sy6-20x-49e"> <div> <h1 font-weigh = "bold">背景信息</h1> </div> <p class="p" id="p-e2t-0mo-87r">FTP（File Transfer Protocol）是一种文件传输协议，基于客户端/服务器架构，支持以下两种工作模式： </p> <ul class="ul" id="ul-cnr-yat-3ha"> <li>主动模式：客户端向FTP服务器发送端口信息，由服务器主动连接该端口。</li> <li>被动模式：FTP服务器开启并发送端口信息给客户端，由客户端连接该端口，服务器被动接受连接。</li> </ul> <div> <div><i class="icon-note note"></i></div> <div><strong>说明</strong> 大多数FTP客户端都在局域网中，没有独立的公网IP地址，且有防火墙阻拦，主动模式下FTP服务器成功连接到客户端比较困难。因此，如无特殊需求，建议您将FTP服务器配置为被动模式。 </div> </div> <p class="p" id="p-wxn-fem-q9l">FTP支持以下三种认证模式： </p> <ul class="ul" id="ul-dmf-0om-cye"> <li>匿名用户模式：任何人无需密码验证就可以直接登录到FTP服务器。这种模式最不安全，一般只用来保存不重要的公开文件，不推荐在生产环境中使用。</li> <li>本地用户模式：通过Linux系统本地账号进行验证的模式，相较于匿名用户模式更安全。</li> <li>虚拟用户模式：FTP服务器的专有用户。虚拟用户只能访问Linux系统为其提供的FTP服务，而不能访问Linux系统的其它资源，进一步增强了FTP服务器的安全性。</li> </ul> <p class="p" id="p-xte-cjq-m66">本教程中主要介绍的FTP服务器被动模式下，匿名用户及本地用户的配置方法。 </p> <div>本教程示例步骤使用以下资源版本： <ul class="ul" id="ul-8u7-l18-he4"> <li>实例规格：ecs.c6.large</li> <li>操作系统：CentOS 7.2 64位</li> <li>vsftpd：3.0.2</li> <li>浏览器：Google Chrome</li> </ul> </div> <p class="p" id="p-6tm-ccu-whk">当您使用不同软件版本时，可能需要根据实际情况调整命令和参数配置。</p> </section> <section class="section" id="section-jes-y83-7zc"> <h1 font-weigh = "bold">操作步骤</h1> <div>Linux实例搭建FTP站点具体步骤如下： <ul class="ul" id="ul-k45-hva-l5p"> <li><a title="" href="#section-821-887-8np">步骤一：安装vsftpd</a></li> <li><a title="" href="#section-7bm-08s-pts">步骤二：配置vsftpd</a></li> <li><a title="" href="#section-cnf-mp9-o24">步骤三：设置安全组</a></li> <li><a title="" href="#section-zhf-ksd-coj">步骤四：客户端测试</a></li> </ul> </div> </section> <section class="section" id="section-821-887-8np"> <h1 font-weigh = "bold">步骤一：安装vsftpd</h1> <ol class="ol steps" id="steps-j6w-1tl-yt0"> <li><span>远程连接Linux实例。</span> <div></div> </li> <li><span>运行以下命令安装vsftpd。</span> <div> <pre><code>yum install -y vsftpd</code></pre> </div> <div>出现如下图所示界面时，表示安装成功。<img class="image break" id="image-4ai-svp-wu5" src="http://qey2kbifv.hn-bkt.clouddn.com/2020-09-04/YuLcX3RfImQANesG8bTF.png" alt="install_vsftp_successfully"></div> </li> <li><span>运行以下命令设置FTP服务开机自启动。</span> <div> <pre><code>systemctl enable vsftpd.service</code></pre> </div> </li> <li><span>运行以下命令启动FTP服务。</span> <div> <pre><code>systemctl start vsftpd.service</code></pre> <div> <div><i class="icon-note note"></i></div> <div><strong>说明</strong> 执行该命令时如果提示错误信息<samp class="ph msgph" id="msgph-t37-vnm-j44">Job for vsftpd.service failed because the control process exited with error code</samp>，请排查是否存在下述问题。如果问题仍未解决，建议提交工单。 <ul class="ul" id="ul-w4n-5oh-03v"> <li>网络环境不支持IPv6时，运行命令<span>vim /etc/vsftpd/vsftpd.conf</span>将内容<code>listen_ipv6=YES</code>修改为<code>listen_ipv6=NO</code>。 </li> <li>MAC地址不匹配时，运行命令<span>ifconfig</span>查看MAC地址，并在<span>/etc/sysconfig/network-scripts/ifcfg-xxx</span>配置文件中新增或修改<code>HWADDR=&lt;MAC地址&gt;</code>。 </li> </ul> </div> </div> </div> </li> <li><span>运行以下命令查看FTP服务监听的端口。 </span> <div> <pre><code>netstat -antup | grep ftp</code></pre> </div> <div> <div>出现如下图所示界面，表示FTP服务已启动，监听的端口号为21。此时，vsftpd默认已开启匿名访问功能，您无需输入用户名密码即可登录FTP服务器，但没有修改或上传文件的权限。<img class="image break" id="image-eem-yuh-2qt" src="http://qey2kbifv.hn-bkt.clouddn.com/2020-09-04/O8YW30ptvK2Ej5LJBN4S.png" alt="install_vsftpd_3"></div> </div> </li> </ol> </section> <section class="section" id="section-7bm-08s-pts"> <h1 font-weigh = "bold">步骤二：配置vsftpd</h1> <p class="p" id="p-vty-cdf-uko">本示例提供两种方式配置vsftpd：匿名用户模式或本地用户模式。请根据您的需求选择其中一种方式进行配置。</p> <p class="p" id="p-zvq-r0l-949">方式一：配置匿名用户上传文件权限。</p> <ol class="ol steps" id="steps-s0s-xvb-2pt"> <li><span>修改配置文件<span>/etc/vsftpd/vsftpd.conf</span>。</span> <div> <div> <div><i class="icon-note note"></i></div> <div><strong>说明</strong> 如果您在安装vsftpd时，使用的是<code>apt install vsftpd</code>安装命令，则配置文件路径为<span>/etc/vsftpd.conf</span>。 </div> </div> </div> <ol type="a" class="ol substeps" id="substeps-og6-z37-1k7"> <li><span>运行<span>vim /etc/vsftpd/vsftpd.conf</span>命令打开配置文件。</span></li> <li><span>按<kbd>i</kbd>进入编辑模式。</span></li> <li><span>将匿名上传权限的注释去掉，修改为<code>anon_upload_enable=YES</code>。</span></li> <li><span>按<kbd>Esc</kbd>退出编辑模式，然后输入<kbd>:wq</kbd>并回车以保存并关闭文件。</span></li> </ol> <div>修改后的配置文件，如下图所示。 <img class="image break" src="http://qey2kbifv.hn-bkt.clouddn.com/2020-09-04/LemU8oiuD9KXZfB0AyRN.png" alt="vsftpd配置文件"></div> </li> <li><span>运行以下命令更改<span>/var/ftp/pub</span>目录的权限，为FTP用户添加写权限。</span> <div><span>/var/ftp/pub</span>为FTP服务默认的文件目录。 <pre><code>chmod o+w /var/ftp/pub/</code></pre> </div> </li> <li><span>运行以下命令重新加载配置文件。</span> <div> <pre><code>systemctl restart vsftpd.service</code></pre> <img class="image break" id="image-e4y-8gr-g2s" src="http://qey2kbifv.hn-bkt.clouddn.com/2020-09-04/u4X8PQgxYIq5AOJsdULo.png" alt="匿名权限2"></div> </li> </ol> <p class="p" id="p-x5q-net-hzg">方式二：配置本地用户访问FTP服务器。</p> <ol class="ol steps" id="steps-t24-phf-58v"> <li><span>运行以下命令为FTP服务创建一个Linux用户。本示例中，该用户名为<span>ftptest</span>。 </span> <div> <pre><code>adduser ftptest</code></pre> </div> </li> <li><span>运行以下命令修改<span>ftptest</span>用户的密码。</span> <div> <pre><code>passwd ftptest</code></pre> </div> </li> <li><span>运行以下命令创建一个供FTP服务使用的文件目录。 </span> <div> <pre><code>mkdir /var/ftp/test</code></pre> </div> </li> <li><span>运行以下命令更改<span>/var/ftp/test</span>目录的拥有者为<span>ftptest</span>。</span> <div> <pre><code>chown -R ftptest:ftptest /var/ftp/test</code></pre> </div> </li> <li><span>修改<span>vsftpd.conf</span>配置文件。 </span> <ol type="a" class="ol substeps" id="substeps-369-4fq-juc"> <li><span>运行<span>vim /etc/vsftpd/vsftpd.conf</span>命令打开配置文件。</span></li> <li><span>按<kbd>i</kbd>进入编辑模式。</span></li> <li><span>根据如下内容，修改或添加相关配置参数。</span> <div> <div> <div><i class="icon-note notice"></i></div> <div><strong>注意</strong> 修改和添加配置文件内的信息时，请注意格式问题。例如，添加多余的空格会造成无法重启服务的结果。 </div> </div> <pre><code>#除下面提及的参数外，其他参数保持默认值即可。

#修改下列参数的值
#禁止匿名登录FTP服务器
anonymous_enable=NO
#允许本地用户登录FTP服务器
local_enable=YES
#监听IPv4 sockets
listen=YES
#在行首添加#注释掉以下参数，关闭监听IPv6 sockets
#listen_ipv6=YES

#添加下列参数
#设置本地用户登录后所在目录
local_root=/var/ftp/test
#全部用户被限制在主目录
chroot_local_user=YES
#启用例外用户名单
chroot_list_enable=YES
#指定例外用户列表文件，列表中用户不被锁定在主目录
chroot_list_file=/etc/vsftpd/chroot_list
#开启被动模式
pasv_enable=YES
allow_writeable_chroot=YES
#本教程中为Linux实例公网IP
pasv_address=<FTP服务器公网IP地址>
#设置被动模式下，建立数据传输可使用的端口范围的最小值
pasv_min_port=<port number>
#设置被动模式下，建立数据传输可使用的端口范围的最大值
pasv_max_port=<port number></code></pre> <div> <div><i class="icon-note note"></i></div> <div><strong>说明</strong> 建议您把端口范围设置在一段比较高的范围内，例如50000~50010，有助于提高访问FTP服务器的安全性。 </div> </div> <p class="p" id="p-cxl-7n3-o28">更多参数详情，请参见<a title="" href="#section-t9a-ors-44c">vsftp配置文件及参数说明</a>。 </p> </div> </li> <li><span>按<kbd>Esc</kbd>退出编辑模式，然后输入<kbd>:wq</kbd>并回车以保存并关闭文件。</span></li> </ol> </li> <li><span>创建<span>chroot_list</span>文件，并在文件中写入例外用户名单。 </span> <ol type="a" class="ol substeps" id="substeps-h4q-52v-crd"> <li><span>运行<span>vim /etc/vsftpd/chroot_list</span>命令创建<span>chroot_list</span>文件。</span></li> <li><span>按<kbd>i</kbd>进入编辑模式。</span></li> <li><span>输入例外用户名单。此名单中的用户不会被锁定在主目录，可以访问其他目录。</span></li> <li><span>按<kbd>Esc</kbd>退出编辑模式，然后输入<kbd>:wq</kbd>并回车以保存并关闭文件。</span></li> </ol> <div> <div> <div><i class="icon-note note"></i></div> <div><strong>说明</strong> 没有例外用户时，也必须创建<span>chroot_list</span>文件，内容可为空。 </div> </div> </div> </li> <li><span>运行以下命令重启vsftpd服务。 </span> <div> <pre><code>systemctl restart vsftpd.service</code></pre> </div> </li> </ol> </section> <section class="section" id="section-cnf-mp9-o24"> <h1 font-weigh = "bold">步骤三：设置安全组</h1> <div>搭建好FTP站点后，在实例安全组的入方向添加规则并放行下列FTP端口。<div> <div><i class="icon-note note"></i></div> <div><strong>说明</strong> 大多数客户端位于局域网中，IP地址是经过转换的，因此<span>ipconfig</span>或<span>ifconfig</span>命令返回的IP不一定是客户端的真实公网IP地址。若后续客户端无法登录FTP服务器，请重新确认其公网IP地址。 </div> </div> </div> <p class="p" id="p-eb2-0q8-svq">FTP被动模式需要开放端口21，以及配置文件<span>/etc/vsftpd/vsftpd.conf</span>中参数<span>pasv_min_port</span>和<span>pasv_max_port</span>之间的所有端口。配置详情如下表所示。 </p><table><thead><tr><th>规则方向</th><th>授权策略</th><th>协议类型</th><th>端口范围</th><th>授权对象</th></tr></thead><tbody><tr><td>入方向</td><td>允许</td><td>自定义TCP</td><td>21/21</td><td>所有要访问FTP服务器的客户端公网IP地址，多个地址之间用逗号隔开。<br>允许所有客户端访问时，授权对象为0.0.0.0/0。</td></tr><tr><td>入方向</td><td>允许</td><td>自定义TCP</td><td>pasv_min_port/pasv_max_port</td><td>所有要访问FTP服务器的客户端公网IP地址，多个地址之间用逗号隔开。<br>允许所有客户端访问时，授权对象为0.0.0.0/0。</td></tr></tbody></table></section> <section class="section" id="section-zhf-ksd-coj"> <h1 font-weigh = "bold">步骤四：客户端测试</h1> <div>FTP客户端、Windows命令行工具或浏览器均可用来测试FTP服务器。本教程以Google Chrome浏览器为例，介绍FTP服务器的访问步骤。 <div> <div><i class="icon-note note"></i></div> <div><strong>说明</strong> 使用浏览器访问FTP服务器出错时，建议您清除浏览器缓存后再尝试。 </div> </div> </div> <ol class="ol steps" id="steps-s51-7yc-0hp"> <li><span>打开客户端的Google Chrome浏览器。</span></li> <li><span>在地址栏中输入<code>ftp://&lt;FTP服务器公网IP地址&gt;:21</code>。</span> <div>本教程中为Linux实例的公网IP地址。</div> </li> <li><span>在弹出的对话框中，输入用户名<span>ftptest</span>和对应的密码，即可对FTP文件进行相应权限的操作。 </span> <div> <div> <div><i class="icon-note note"></i></div> <div><strong>说明</strong> 此步骤仅适用于本地用户，匿名用户无需输入用户名和密码即可登录FTP服务器。 </div> </div> </div> </li> </ol> </section> <section class="section" id="section-t9a-ors-44c"> <h1 font-weigh = "bold">vsftp配置文件及参数说明</h1> <div><span>/etc/vsftpd</span>目录下文件说明如下： <ul class="ul" id="ul-vwr-tz9-i0p"> <li><span>/etc/vsftpd/vsftpd.conf</span>是vsftpd的核心配置文件。 </li> <li><span>/etc/vsftpd/ftpusers</span>是黑名单文件，此文件中的用户不允许访问FTP服务器。 </li> <li><span>/etc/vsftpd/user_list</span>是白名单文件，此文件中的用户允许访问FTP服务器。 </li> </ul> </div> <div>配置文件<span>vsftpd.conf</span>参数说明如下： <ul class="ul" id="ul-wax-po9-0kp"> <li>工作模式说明如下表所示。 <table><thead><tr><th>参数</th><th>说明</th></tr></thead><tbody><tr><td>pasv_enable=YES</td><td>开启被动模式</td></tr><tr><td>pasv_enable=NO</td><td>开启主动模式</td></tr><tr><td>不设置该参数</td><td>配置文件中默认不设置该参数，表示使用被动模式</td></tr></tbody></table> <div> <div><i class="icon-note note"></i></div> <div><strong>说明</strong> 当您需要开启主动模式时，QVM实例的安全组规则需要放行20与21端口。 </div> </div> </li> <li>用户登录控制参数说明如下表所示。 <table><thead><tr><th>参数</th><th>说明</th></tr></thead><tbody><tr><td>anonymous_enable=YES</td><td>接受匿名用户</td></tr><tr><td>no_anon_password=YES</td><td>匿名用户login时不询问口令</td></tr><tr><td>anon_root=（none）</td><td>匿名用户主目录</td></tr><tr><td>local_enable=YES</td><td>接受本地用户</td></tr><tr><td>local_root=（none）</td><td>本地用户主目录</td></tr></tbody></table> </li> <li>用户权限控制参数说明如下表所示。 <table><thead><tr><th>参数</th><th>说明</th></tr></thead><tbody><tr><td>write_enable=YES</td><td>可以上传文件（全局控制）</td></tr><tr><td>local_umask=022</td><td>本地用户上传的文件权限</td></tr><tr><td>file_open_mode=0666</td><td>上传文件的权限配合umask使用</td></tr><tr><td>anon_upload_enable=NO</td><td>匿名用户可以上传文件</td></tr><tr><td>anon_mkdir_write_enable=NO</td><td>匿名用户可以建目录</td></tr><tr><td>anon_other_write_enable=NO</td><td>匿名用户修改删除</td></tr><tr><td>chown_username=lightwiter</td><td>匿名上传文件所属用户名</td></tr></tbody></table></li> </ul> </div> </section> <section class="section postreq" id="postreq-70i-wjf-qwx"> <div> <h1 font-weigh = "bold">后续步骤</h1> </div> <p class="p" cond-props="china" id="p-cv1-llq-10l">对FTP服务进行安全加固。</p> </section> </div> </article> </main> <script>$icmsDocProps={'productMethod':'created','language':'zh-CN',};</script></div> </div>