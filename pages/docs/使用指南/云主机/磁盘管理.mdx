<a id="step01"></a>
# **创建数据盘** 

创建数据盘的方式包括：

- 使用快照创建数据盘，请参考[用快照创建磁盘](#step07)

- 随实例一起创建数据盘，请参考[创建实例](/qvm/manual/qvm-linux-quickstart#2)

- 单独创建全新的空数据盘

这里介绍如何在控制台上创建一个全新的空数据盘：

1. 登录[云主机管理控制台](https://portal.qiniu.com/qvm/instance)

2. 在左侧导航栏中，单击**存储 > 云硬盘**

3. 在磁盘列表页，单击左上角的**新建**进入创建磁盘页面

4. 选择**地域和可用区**，购买的云盘必须与实例在同一个可用区内才能挂载

5. 选择云盘的类型和容量。你也可以选择[用快照创建磁盘](#step07)。

6. 确认配置费用，单击**确定**

购买全新的空数据盘后，你需要按照以下步骤操作完成后才能在系统中看到并使用数据盘：

1. 在控制台上将数据盘挂载到实例上，具体操作请参考[挂载数据盘](#step02)

2. 登录实例完成格式化、分区磁盘。

- Linux 实例请参考[Linux 格式化和挂载数据盘](/qvm/manual/qvm-linux-quickstart#linux-mount-format-disk)

- Windows 实例请参考[Windows 格式化数据盘](/qvm/manual/qvm-linux-quickstart#windows-format-disk)

<br>

<a id="step07"></a>
# **用快照创建云硬盘** 

用快照创建磁盘的前提是你已经[创建磁盘快照](/qvm/manual/qvm-snapshot#1)

1. 登录[云主机管理控制台](https://portal.qiniu.com/qvm/instance)

2. 在左侧导航栏中，单击**存储 > 云硬盘**

3. 单击**新建**

4. 选择**地域和可用区**，购买的云盘必须与实例在同一个可用区内才能挂载

5. 开启**用快照创建**，选择快照

6. 确认配置费用，单击**确定**

<br>

<a id="step02"></a>
# **挂载数据盘** 

你可以选择从实例入口挂载数据盘，也可以从云盘入口挂载数据盘。选择入口时，请参考以下说明：

- 如果你要在一个实例上挂载多个云盘，从实例入口操作比较方便

- 如果你要将多个云盘挂载到不同的实例上，从云盘入口操作比较方便

<br>

<a id="step021"></a>
### **从实例入口挂载磁盘** 

1. 登录[云主机管理控制台](https://portal.qiniu.com/qvm/instance)

2. 在左侧导航栏中，单击**实例**

3. 找到需要挂载数据盘的实例，单击实例名称

4. 在顶部导航栏中，单击**数据盘管理**，在磁盘列表页左上方单击**挂载磁盘**

5. 在弹出对话框中，选择你需要挂载的磁盘，单击**确定**

6. 新本实例磁盘列表页，如果该云盘的状态变为**使用中**，表示挂载成功

<br>

<a id="step022"></a>
### **从云盘入口挂载磁盘** 

1. 登录[云主机管理控制台](https://portal.qiniu.com/qvm/instance)

2. 在左侧导航栏中，单击**存储 > 云硬盘**

3. 选择同一可用区的空闲云盘，在**操作**列中选择**挂载**

4. 在弹出对话框中，选择目标实例，单击**确定**

5. 刷新云盘列表页，如果该云盘的状态变为**使用中**，表示挂载成功

<br>

<a id="step03"></a>
# **卸载数据盘** 

卸载数据盘时候，注意以下事项：

- 在 Windows 操作系统下，为了保证数据完整性，建议你暂停对该磁盘的所有文件系统的读写操作，否则未完成读写的数据会丢失。

- 在 Linux 操作系统下，你需要登录实例中对该磁盘进行`umount`命令行操作，命令执行成功后再进入控制台对磁盘进行卸载操作。

<br>

<a id="step031"></a>
### **通过实例卸载** 

1. 登录[云主机管理控制台](https://portal.qiniu.com/qvm/instance)

2. 单击左侧菜单中的**实例**

3. 单击需要卸载磁盘所属的实例名称，或者选择实例页面右侧的**操作 > 管理数据盘**

4. 单击顶部菜单中的**数据盘管理**。在该页面里显示的是已挂载在该实例上的磁盘。
单击要卸载的磁盘。

5. 选择需要卸载的数据盘，单击**卸载**

6. 选在弹出的对话框中，单击**确定**

<br>

<a id="step032"></a>
### **通过磁盘卸载** 

1. 登录[云主机管理控制台](https://portal.qiniu.com/qvm/instance)

2. 单击左侧菜单中的**云硬盘**

3. 选择要卸载的磁盘名称。磁盘的状态必须为**使用中**。

4. 选择**操作**列中的**卸载**

5. 在弹出的对话框中，单击**确定**

<br>

<a id="step04"></a>
# **删除数据盘** 

1. 登录[云主机管理控制台](https://portal.qiniu.com/qvm/instance)

2. 在左侧导航栏中，选择**存储 > 云硬盘**

3. 找到需要删除的数据盘，在**操作**列中，选择**删除**

4. 在弹出的对话框中，确认信息后，单击**确定**

<br>

<a id="step05"></a>
# **扩容数据盘** 

根据磁盘类别不同，允许扩容的上限不同。

| 数据盘类别 | 扩容前容量 | 扩容后容量上限 |
| -------- | ------- | ---------- |
| 普通云盘 |  无限制 | 2000 GB |
| SSD 云盘或高效云盘 | 小于等于 2048 GB | 2048 GB |
| SSD 云盘或高效云盘 | > 2048 GB | 不支持扩容 |

<br>

<a id="step051"></a>
## Linux 实例扩容数据盘 

随着业务的增长，你的数据盘容量可能无法满足数据存储的需要，这时你可以使用磁盘**扩容**功能扩容数据盘。挂载在实例上的数据盘，只有当实例处于**运行中**或**已关机**状态时才可以扩容。扩容这种数据盘需要在控制台上重启实例后才能使扩容后的容量生效，而重启实例会停止实例，中断你的业务，所以请你谨慎操作。无论数据盘的状态是**空闲**还是**使用中**，都可以执行磁盘扩容操作。

建议在扩容数据盘之前手动创建快照，以备份数据。本文以一个高效云盘的数据盘和一个运行 CentOS 7.3 64 位的实例为例，说明如何扩容数据盘并使扩容后的容量可用。你可以按以下步骤完成扩容操作：

step01 [在控制台上扩容数据盘的磁盘空间](#step0511)

step02 [登录实例完成扩容](#step0512)

<br>

<a id="step0511"></a>
**在控制台上扩容数据盘的磁盘空间**

1. 登录[云主机管理控制台](https://portal.qiniu.com/qvm/instance)

2. 在左侧导航栏中，选择**云主机 > 云硬盘**

3. 找到需要扩容的磁盘，并在**操作**列中，选择**扩容**

![image.png](https://dn-odum9helk.qbox.me/FibNYVOcN6rCHyya1Uvl_QtLrEPg)

4. 在云硬盘扩容**页面上，设置目标容量，在本示例中为 30 GB。

5. 单击**确定**

6. 如果你的数据盘已经挂载到实例上，你需要在控制台上「重启实例」才能使扩容生效。

在控制台上完成扩容数据盘后：你需要先「格式化」和「挂载」数据盘，如果你已经格式化和挂载数据盘到实例上，可以直接「登录实例」完成扩容。

<br>

<a id="step0512"></a>
**登录实例扩容文件系统**

在控制台上完成磁盘扩容后，磁盘每个分区的文件系统并未扩容。你需要登录实例扩容文件系统。

在本示例中，假设数据盘挂载在一台 Linux 实例上，实例的操作系统为 CentOS 7.3 64 位，未扩容前的数据盘只有一个主分区（/dev/vdb1，ext4 文件系统），文件系统的挂载点为 /mnt，文件系统扩容完成后，数据盘仍然只有一个主分区。

1. 远程连接实例

2. 运行`umount [文件系统名称]`命令卸载主分区

```
 umount /dev/vdb1
```

3. 使用`fdisk`命令删除原来的分区并创建新分区：

- 运行命令`fdisk -l`罗列分区信息并记录扩容前数据盘的最终容量、起始扇区位置。

- 运行命令`fdisk [自定义数据盘设备名]`进入 fdisk 界面。本示例中，命令为`fdisk /dev/vdb`

-  输入`d`并按回车键，删除原来的分区。删除分区不会造成数据盘内数据的丢失。

- 输入`n`并按回车键，开始创建新的分区。

- 输入`p`并按回车键，选择创建主分区。因为创建的是一个单分区数据盘，所以只需要创建主分区。如果要创建 4 个以上的分区，你应该创建至少一个扩展分区，即选择`e`。

- 输入分区编号并按回车键。因为这里仅创建一个分区，所以输入`1`。

- 输入第一个可用的扇区编号：为了保证数据的一致性，起始扇区需要与原来的分区保持一致。在本示例中，按回车键采用默认值。

- 输入最后一个扇区编号：因为这里仅创建一个分区，所以按回车键采用默认值。

- 输入`wq`并按回车键，开始分区。

![分区](https://dn-odum9helk.qbox.me/FiX00Q1ZiyWPDJYk62b3CQ8-_YkU)

4. （可选）部分操作系统里，修改分区后可能会重新自动挂载文件系统。建议先执行`df -h`重新查看文件系统空间和使用情况。如果文件系统重新被挂载，执行`umount [文件系统名称]`再次卸载文件系统。

5. 检查文件系统，并变更文件系统大小

```
e2fsck -f /dev/vdb1 #检查文件系统
resize2fs /dev/vdb1 #变更文件系统大小
```

以下为示例输出结果：

![检查文件系统](https://dn-odum9helk.qbox.me/Fs0U80TLLv14DOTiHHakqcSPvgDS)

6. 将扩容完成的文件系统挂载到原来的挂载点（如本示例中的 /mnt）。

```
mount /dev/vdb1 /mnt
```

7. 查看文件系统空间和使用情况：运行命令`df -h`。如果出现扩容后的文件系统信息，说明挂载成功，可以使用扩容后的文件系统了。挂载操作完成后，不需要在控制台上重启实例即可开始使用扩容后的文件系统。

以下为示例输出结果：

![文件系统信息](https://dn-odum9helk.qbox.me/FqJa6LVP-b784U2dLyphAFDgeW7T)

<br>

<a id="step052"></a>
## **Windows 实例扩容数据盘** 

随着业务的增长，你的数据盘容量可能无法满足数据存储的需要，这时你可以使用磁盘**扩容**功能扩容数据盘。建议在扩容数据盘之前手动创建快照，以备份数据。无论数据盘的状态是**空闲**还是**使用中**，都可以执行磁盘扩容操作。扩容磁盘只是扩大数据盘容量，而不是扩容文件系统。挂载在实例上的数据盘，只有当实例处于**运行中**或**已关机**状态时才可以扩容。扩容这种数据盘需要在控制台上重启实例后才能使扩容后的容量生效，而重启实例会使你的实例停止工作，从而中断你的业务，所以请你谨慎操作。

本文以一个高效云盘的数据盘和一个运行 Windows Server 2008 R2 企业版 64 位中文版的实例为例，说明如何扩容数据盘并使扩容后的容量可用。示例中最初的磁盘大小为 24 GB，我们将其扩容到 26 GB。你可以按以下步骤完成扩容操作：

step01 [在控制台上扩容数据盘](#step0521)

step02 [登录实例完成扩容](#step0522)

<br>

<a id="step0521"></a>
**在控制台上扩容数据盘的磁盘空间**

1. 登录[云主机管理控制台](https://portal.qiniu.com/qvm/instance)

2. 在左侧导航栏中，选择**云主机 > 云硬盘**

3. 找到需要扩容的磁盘，并在**操作**列中，选择**扩容**

4. 在**云硬盘扩容**页面上，设置**目标容量**，在本示例中为 26 GB。

5. 单击**确定**

扩容成功后，磁盘列表里即显示扩容后的容量。但是，如果你的数据盘已经挂载到实例上，你需要在控制台上[重启实例](/qvm/manual/qvm-instance#4)后，远程登录实例才能看到扩容后的数据盘容量。

在控制台上完成扩容数据盘后：你需要先[格式化数据盘](/qvm/manual/qvm-linux-quickstart#windows-format-disk)，如果你已经格式化和挂载数据盘到实例上，可以直接[登录实例完成扩容](#step0522)。

<br>

<a id="step0522"></a>
## 登录实例扩容文件系统

1. 远程连接实例

2. 在 Windows Server 桌面，单击服务器管理器图标

![服务器管理图标](https://dn-odum9helk.qbox.me/FpGJ1oZ7kexHV6RBPx3xMGUSXpeX)


3. 在**服务器管理器**的左侧导航窗格里，选择**存储 > 磁盘管理**。在磁盘管理区域，可以看到新增的数据盘空间与旧的数据盘空间之间的关系。本例中，磁盘 1 是扩容的数据盘。 

4. 右键单击**磁盘 1**，选择**转换到动态磁盘**，并按页面提示将基本磁盘转换为动态磁盘。 

*注意*：基本磁盘转换成动态磁盘，操作的过程中会将磁盘从系统中卸载下来。如果数据盘内安装了应用程序，转换过程中这些应用程序暂时无法使用。转换过程中不会造成数据丢失。

完成转换后，磁盘 1 在磁盘管理器中显示如下:
![转换后](https://dn-odum9helk.qbox.me/Fp-q7tQXeKw3K0MhW2m-0GJyE-D4)

**5. **右键单击磁盘 1 的简单卷的任一空白处，并选择**扩展卷**

**6. **根据**扩展卷向导**的指示完成扩展卷操作。完成后，新增的数据盘空间会自动合入原来的卷中，磁盘 1 在磁盘管理器中显示如下:

![扩展卷向导](https://dn-odum9helk.qbox.me/Fr1VvIJkbtNKiAvNtqsjst6dDXJF)

至此，你已经完成了扩容数据盘。

<br>

<a id="step06"></a>
# **回滚硬盘** 

如果当前系统出现问题，你希望将一块磁盘的数据回滚到之前的某一时刻，你可以通过回滚磁盘实现，前提是该磁盘已经[创建了快照](/qvm/manual/qvm-snapshot#1)。

提醒：

- 回滚磁盘是不可逆操作，一旦回滚完成，原有的数据将无法恢复，请谨慎操作。

- 回滚磁盘后，从所使用的快照的创建日期到当前时间这段时间内的数据都会丢失。

1. 登录[云主机管理控制台](https://portal.qiniu.com/qvm)

2. 在左侧导航栏中，单击**快照**

3. 选择需要回滚的快照，在**操作**列中，单击**回滚硬盘**

4. 在弹出的提示框中，单击**确定**

如果你勾选了**回滚后立即启动实例**，磁盘回滚完成后，实例会自动启动。如果遇到错误`[403] 指定实例的当前状态不支持该操作。`可能是磁盘所挂载的实例还没有完全停止，只有当实例处于**已关机**状态时，你才能回滚磁盘。

如果数据盘创建快照后，你做过扩容操作，回滚磁盘后，你需要登录实例重新扩容文件系统。具体操作请参考：

- [Linux 实例扩容文件系统](#step0511)

- [Windows 实例扩容文件系统](#step0522)

