<a id="step01"></a>
# **后端服务器概述**

在使用负载均衡服务前，你需要添加 QVM 实例作为负载均衡实例的后端服务器，用来接收负载均衡监听转发的请求。

你可以在任意时刻增加或减少负载均衡实例的后端服务器数量，还可以在不同 QVM 实例之间进行切换。但是为了保证你对外服务的稳定性，确保在执行上述操作时，开启了负载均衡的健康检查功能并同时保证负载均衡实例中至少有一台正常运行的服务器。

负载均衡服务通过设置虚拟服务地址，将添加的同一地域的多台 QVM 实例虚拟成一个高性能、高可用的应用服务池。默认后端服务器是在实例维度上维护的，即负载均衡实例下的所有监听都只能够将流量转发到相同服务器的相同端口上。

你也可以通过服务器组的方式添加服务器。不同的监听可以关联不同的服务器组，这样一个负载均衡实例的不同监听就可以将请求转发给不同的服务器组内不同端口的不同服务器。

    注意：如果你在配置监听时，选择使用服务器组，那么该监听会将请求转发到关联的服务器组中的服务器，而不会再将请求转发给后端服务器池中的服务器。

<br>

<a id="step013"></a>
### **主备服务器组**

当你有主备需求时，即后端服务器中有一台主机和一台备机。当主机工作正常时，流量将直接走主机；当主机宕机时，流量将走到备机。此时，可以使用主备服务器组，避免服务中断。

由于备机不会做健康检查，所以只要主机健康检查失败，系统会直接将流量切到备机。当主机健康检查成功恢复服务后，流量会自动切到主机。

主备服务器组是在监听维度上维护的，并且只支持四层监听，详情请参考[创建主备服务器组](#step03)。

<br>

<a id="step012"></a>
### **虚拟服务器组**

当你需要将不同的请求转发到不同的后端服务器上时，或需要通过域名和 URL 进行请求转发时，可以选择使用虚拟服务器组。详情请参考[创建虚拟服务器组](#step04)。

<br>

<a id="step014"></a>
### **注意事项**

- 负载均衡不支持跨地域部署，确保 QVM 实例的所属地域和负载均衡实例的所属地域相同。

- 负载均衡本身不会限制后端 QVM 实例使用哪种操作系统，只要你的两台 QVM 实例中的应用服务部署是相同的且保证数据的一致性即可。建议你选择相同操作系统的 QVM 实例作为后端服务器，以便日后管理和维护。

- 一个负载均衡实例最多支持添加 50 个监听，每个监听对应后端 QVM 实例上的一个应用。负载均衡监听的前端端口对应后端 QVM 实例上的应用服务端口。

- 你可以指定后端服务器池内各 QVM 实例的转发权重。权重越高的 QVM 实例将被分配到更多的访问请求，你可以根据后端 QVM 实例的对外服务能力和情况来区别设定。

      注意：如果你同时开启了会话保持功能，那么有可能会造成对后端应用服务器的访问并不是完全相同的。如果出现了访问不均衡的情况，建议你可以暂时关闭会话保持功能，观察一下是否依然存在这种情况。

   当负载均衡服务分发请求不均匀时，可以参考以下方法检查处理：

  - 统计一个时间段内，后端 QVM 实例的 Web 服务访问日志记录数据量。

 - 按照负载均衡的配置，对比多台 QVM 实例日志的数量是否有相差。（如设置会话保持，需要剥离相同 IP 的访问日志。如果负载均衡配置了权重，要根据权重比例计算日志中访问比例是否正常。）

<br>

<a id="step02"></a>
# **添加后端服务器**

**1. **登录[负载均衡管理控制台](https://portal.qiniu.com/qvm/slb)

**2. **在负载均衡实例页面，单击目标实例的 ID 链接，进入负载均衡实例的详情页面

**3. **在顶部导航栏，单击**后端服务器**

**4. **在后端服务器页面，单击** 绑定**

**5. **勾选☑️目标实例，然后单击**下一步**

**6. **在**绑定后端服务器**对话框，修改后端服务器的权重，然后点击**确定**

<br>

<a id="step03"></a>
# **创建主备服务器组**

当你有传统的主备需求时，即后端服务器中有一台主机和一台备机，可选择使用主备服务器组。当主机正常工作时，流量将直接走主机；当主机不可用时，流量将走到备机，避免服务中断。

主备服务器组和虚拟服务器组都是在监听维度上维护的，即实例下的不同监听可将流量转发到不同的服务器组。但是一个虚拟服务器组可以添加多个实例，而一个主备服务器组只允许添加两个实例，其中一个作为主机，另外一个作为备机。

    注意：主备服务器组只支持四层监听（TCP 和 UDP 协议）

操作步骤：

**1. **登录[负载均衡管理控制台](https://portal.qiniu.com/qvm/slb)

**2. **在负载均衡实例页面，单击目标实例的 ID 链接，进入负载均衡实例的详情页面

**3. **在顶部导航栏，单击**主备服务器组**

**4. **在主备服务器组页面，单击**添加**

**5. **在添加主备服务器组对话框，勾选目标实例，单击**下一步**

**6. **在**名称**文本框中，输入主备服务器组名称。输入实例端口，修改实例权重，并选择作为备服务器的实例，单击**确定**

<br>

<a id="step04"></a>
# **创建虚拟服务器组**

虚拟服务器组是一组 QVM 实例。虚拟服务器组允许你在监听维度上个性化定义服务器组，即负载均衡实例下的不同监听可使用不同的后端服务器组，可满足域名和 URL 转发个性化需求。

如果你没有创建虚拟服务器组，负载均衡实例会将请求按照你设置的权重和监听规则转发给所有添加的后端服务器；如果你创建了虚拟服务器组，负载均衡实例会将请求按照你设置的监听规则转发给关联的虚拟服务器组，默认实例维度添加的独立的后端服务器不再接收请求。

**注意：**如果你在一个负载均衡实例的 HTTP/HTTPS 监听下，添加了后端服务器、虚拟服务器组和转发规则，请求转发的顺序如下：

（1）判断请求其是否能够匹配上某条转发规则，如果匹配，则将流量转发到该规则的虚拟服务器组。

（2）若不匹配并且在该监听上设置了虚拟服务器组，那么将流量转发到监听关联的虚拟服务器组。

（3）若你没有在该监听上设置虚拟服务器组，即将流量转发到实例级别添加的各后端服务器。

使用说明：

- 虚拟服务器组只能添加监听所在地域的后端服务器。

- 一个后端服务器可以属于多个虚拟服务器组。

- 一个虚拟服务器组可绑定在一个实例的多个监听上。

- 虚拟服务器组由 服务器+端口 组成。

操作步骤：

**1. **登录[负载均衡管理控制台](https://portal.qiniu.com/qvm/slb)

**2. **在负载均衡实例页面，单击目标实例的 ID 链接，进入负载均衡实例的详情页面

**3. **在顶部导航栏，单击**虚拟服务器组**

**4. **在虚拟服务器组页面，单击**添加**

**5. **在添加虚拟服务器组对话框，勾选目标实例，单击**下一步**

**6. **在**名称**文本框中，输入虚拟服务器组名称。输入实例端口，修改实例权重，单击**确定**
