转码是多媒体处理中重要的一步，本文为您介绍转码的简介，如何通过上传自动触发方式、控制台、API发起转码，并为您详细介绍普通转码预设的参数。

# **简介**

**什么是普通转码**

视频转码（Video Transcoding）是指将已经压缩编码的视频码流转换成另一个视频码流，以适应不同的网络带宽、不同的终端处理能力和不同的用户需求。转码本质上是一个先解码、再编码的过程，因此转换前后的码流可能遵循相同的视频编码标准，也可能不遵循相同的视频编码标准。

转码在视频生产流程中的位置如下：

![](https://dora-doc.qiniu.com/WX20201210-151346%402x.png)

  ​
**转码功能特性**

- 视频处理：完善的转码与转封装]能力，进行丰富的媒体格式转换。
- 音频处理：音频转码、音频抽取、音频替换、音频混音等。
- 水印：支持图片水印、文字水印，并且支持多水印添加。
- 多清晰度预设：标清、全高清、2k、4k等多个预置清晰度，提供最佳经验值，降低接入门槛。
- 片段截取：是指裁剪视频的某一段，输出成一个新视频。常用于截取视频中精彩或关键的内容。
- 视频马赛克：在视频中添加马赛克，满足遮标需求。


**使用场景**

- 多终端设备适配：适配PC、TV以及移动终端等多平台播放。
- 多种网络环境适配：多种网络环境适配：不同网络带宽的用户选择最佳码率，流畅播放
- 水印添加：在视频上添加企业Logo、电视台台标、用户ID或昵称等标志性信息，用于品牌宣传或者宣示当前视频的版权归属。


**不转码的情况**

- 如果用户已经自己在本地进行过转码操作，不需要进行二次处理，也可以选择不转码。
- 在短视频等场景下，视频通常已在端上进行过拍摄和压缩，已经具备多终端播放的能力。此时可以不进行转码。



  ​
# **发起转码的方式**

- 通过上传自动触发方式转码

  - 登录 **[智能多媒体]()**，点击左侧【导航栏->任务触发器】，进入任务触发器列表页。

  - 创建一个转码的任务触发器，具体操作，请参考 [任务触发器](https://developer.qiniu.com/dora/manual/6489/task-workflow)

    ![img](https://dora-doc.qiniu.com/WX20201210-165435.png)

  - 可根据配置的回调，将转码后的任务处理结果回调给用户。

- 通知指定文件发起转码

  - 用户对 bucket 中已存在的多媒体文件发起转码。

  - 登录 **[智能多媒体]()**，点击左侧【导航栏->任务】，进入添加任务页面。选择需要使用的工作流（或者自定义工作流），单击**保存**，即可触发转码，具体操作，请参考 [添加任务](https://developer.qiniu.com/dora/manual/6488/task-01)

    ![img](https://dora-doc.qiniu.com/WX20201210-172128.png)

- 通过API发起转码

  - 通过调用 API 手动发起转码处理任务请求。该操作常用于工作流无法满足用户场景时，需用户自己判断业务逻辑，使用API提交转码任务。例如：并不是所有的视频都需要转码，不同视频需要设置不同的转码配置。

    ​
  ​

# **普通转码参数说明**

转码参数十分复杂，为了避免用户将过多精力集放在参数管理，控制台可以将这一系列复杂参数保存为预设。用户可自行定义转码预设，它是转码参数（音频、视频等）的集合，可以满足用户个性化的转码需求。方便用户低门槛、快速使用。

下面对各类型参数的关键参数含义及取值范围进行说明。

#### **1. 封装格式**

| 中文名   | 参数名称   | 必填 | 说明                                     |
| -------- | ---------- | ---- | ---------------------------------------- |
| 封装格式 | `<Format>` | Y    | 封装格式支持以下四种：mp4、hls、flv、mp3 |

#### **2. 视频参数**

| 中文名                | 参数名称                 | 必填                                                         | 说明                                                         |
| --------------------- | ------------------------ | ------------------------------------------------------------ | ------------------------------------------------------------ |
| 禁用视频              | `/vn/<VideoNo>`          | N                                                            | 是否去除视频流，默认保留，勾选禁用视频后，会去除视频流。     |
| 编码格式              | `/vcodec/<VideoCodec>`   | N                                                            | 视频编码格式，支持 H.264 和 H.265 两种。                     |
| 码率                  | `/vb/<VideoBitRate>`     | N                                                            | 1、视频码率，单位：千比特每秒（kbit/s），常用视频码率：128k，1.25m，5m等，码率限制大小为 [10，60000]，支持到小数点后一位。2、在不改变视频编码格式时，若指定码率大于原视频码率，则使用原视频码率进行转码。3、勾选【强制使用】，可以强制指定码率进行转码。 |
| crf                   | `/h264Crf/<H264Crf>`     | N                                                            | 设置crf值，为整数，编码格式为 H.264 时取值为范围 [18,28]，编码格式为  H.265 时取值范围为 [23,33]，默认取值为范围 [18,28]；其值越小，输出视频质量越好，输出文件可能变大。注意：不可与视频码率共用。 |
| 分辨率                | `/s/<Resolution>`        | N                                                            | 0、指定目标视频分辨率，格式为宽 x 高 ，长边取值范围[20,3840]的整数，短边取值范围[20,2160]的整数。1、w、h 都为空时，则和原视频保持一致。2、`w`为空，`h`不为空，则按`h`的值对原视频等比例缩放。`3、w`不为空，`h`为空时，则按`w`的值对原视频等比例缩放。`4、w`、`h`都不为空时，则根据`w`、`h`来缩放。 |
| 在播放器中宽高比      | `/aspect/<Aspect>`       | N                                                            | 该参数为视频在播放器中显示的宽高比，格式为`<width>:<height>`。例如：取值`3:4`表示视频在播放器中播放是`宽:高`=`3:4`（注：此处取值仅为体现演示效果)。 |
| 视频按比例缩放        | `/autoscale/<Autoscale>` | N                                                            | 0、配合分辨率参数使用。1、指定为1时，把视频按原始比例缩放到分辨率指定的矩形框内。2、指定为2时，把视频按分辨率中指定的比例添加黑框后，再等比例缩放到分辨率指定到矩形框内。3、关闭时，会强制缩放到对应分辨率，可能造成视频变形。 |
| 帧率                  | `/r/<FrameRate>`         | N                                                            | 0、视频帧率，每秒显示的帧数，单位：赫兹（Hz），常用帧率：24，25，30等，帧率限制大小在 [1，60]。1、取值范围为 `[1,30]的整数，按照普通帧率进行收费。`2、取值范围为 (30 , 60]的整数，按照高帧率进行收费，[参考价格详情](https://www.qiniu.com/prices?source=dora)。 |
| `/hr/<HighFrameRate>` | N                        | 视频高帧率，与`FrameRate`配合使用，默认为`HighFrameRate=0`，即常规帧率；`HighFrameRate=1`表示保留高帧率。 | 1、此处在后端做逻辑判断，前端页面不展示。                    |
| 关键帧最大间隔        | `/gop/<GroupOfPictures>` | N                                                            | GOP参数，即视频流关键帧间的间隔帧数，取值[1,3000]的整数；默认为0表示采用指定视频编码格式的默认GOP值，例如libx264格式默认GOP值为250。GOP取值过小会影响视频编码压缩率，码率变大，过大会使图像群组的时长跨度过大，影响播放随机性，故一般建议采用默认值。 |

#### **2.1 视频高级参数**

| 类别         | 中文名     | 参数名称                           | 必填 | 说明                                                         |
| ------------ | ---------- | ---------------------------------- | ---- | ------------------------------------------------------------ |
| 片段截取     | 开始时间   | `/ss/<SeekStart>`                  | N    | 1、用于音视频截取，从一段音视频中截取一段音视频；2、指定音视频截取的开始时间，单位：秒，支持精确到毫秒，例如3.345s。 |
|              | 截取长度   | `/t/<Duration>`                    | N    | 1、用于视频截取，从一段视频中截取一段视频；2、指定音视频截取的长度，单位：秒，支持精确到毫秒，例如1.500s。 |
| 视频旋转     | 顺时针旋转 | `/rotate/<Degree>`                 | N    | 指定顺时针旋转的度数，可取值为`90`、`180`、`270`、`auto`，默认为 auto。 |
|              | 视频翻转   | `/flip/<Flip>`                     | N    | 视频翻转, 水平翻转 `horizontal`, 垂直翻转 `vertical。`       |
| 视频马赛克   | 马赛克位置 | `/mosaicGravity/<MosaicGravity>`   | N    | 马赛克的位置，参考锚点参数表，默认值为`NorthEast`（右上角）  |
|              | 马赛克位置 | `/mosaicOffsetX/<MosaicOffsetX>`   | N    | 马赛克位置的相对横向偏移量 `，正数则向右偏移，负数向左偏移。` |
|              | 马赛克位置 | `/mosaicOffsetY/<MosaicOffsetY>`   | N    | 马赛克位置的相对纵向偏移量 `，正数则向下偏移，负数向上偏移。` |
|              | 马赛克大小 | `/mosaicSize/<MosaicSize>`         | N    | 马赛克区域大小，即指定马赛克的宽和高。                       |
|              | 起始时间   | `/mosaicStart/<MosaicStart>`       | N    | 马赛克起始时间， 默认为0。                                   |
|              | 持续时间   | `/mosaicDuration/<MosaicDuration>` | N    | 马赛克持续时间， 默认直到片尾                                |
| 清除metadata |            | `/stripmeta/<StripMeta>`           | N    | 是否清除文件的`metadata`，1为清除，0为保留。                 |

#### **3. 音频参数**

| 中文名   | 参数名称               | 必填 | 说明                                                         |
| -------- | ---------------------- | ---- | ------------------------------------------------------------ |
| 禁用音频 | `/an/<AudioNo>`        | N    | 是否去除音频流，0为保留，1为去除。默认值为0。                |
| 编码格式 | `/acodec/<AudioCodec>` | N    | 1、音频编码格式，支持 MP3 、AAC 、AAC_HE。2、为空时，与源视频一致 |
| 声道数   | `/ac/<ChannelNum>`     | N    | 1、音频声道数量，单位：整数值，输出文件的声道数不能大于输入源的声道数量；2、目前 acodec 为 aac 时，支持的声道数量为 1、2、4、5、6、8，其他数值不合法；3、acodec 为mp3 时，支持的声道数量为 1、2，其他数值不合法。备注：当编码格式为空时，声道数也为空，默认与源视频一致。 |
| 码率     | `/ab/<BitRate>`        | N    | 1、音频码率，单位：比特每秒（kbit/s），常用码率：64k，128k，192k，256k，320k等，音频码率限制大小为 [1，600]，支持到小数点后一位。2、在不改变音频编码格式时，若指定码率大于原音频码率，则使用原音频码率进行转码。3、勾选【强制使用】，可以强制指定码率进行转码。 |
| 采样率   | `/ar/<SamplingRate>`   | N    | 1、音频采样频率，单位：赫兹（Hz），取值为整数。2、常用音频采样频率有 8000, 11025、12000、16000、22050、24000、32000、44056、44100、47250、48000、50000、64000、88200、96000 等。 |

#### **3.1 音频高级参数**

| 类别           | 中文名               | 参数名称                                          | 必填 | 说明                                                         |
| -------------- | -------------------- | ------------------------------------------------- | ---- | ------------------------------------------------------------ |
| 音频混音       | 混音文件             | `/amix/<AmixURL>`                                 | N    | 1、期望混音的音视频文件；2、源音视频、混音文件都仅支持单音轨；3、混音的两个音频的 channel 数必须一致。备注：不支持与音频替换同时使用。 |
|                | 开始混音时间         | `/amixOffset/<AmixOffset>`                        | N    | 混音效果起始位置，相对于混音后视频起始位置计算，单位为秒，精确到毫秒，默认取0，即混音后音视频从起始位置起有混音效果 |
|                | 混音文件截取开始时间 | `/amixStart/<AmixStart>`                          | N    | 1、用于混音文件长度截取；2、混音文件截取的开始时间，单位为秒，精确到毫秒；3、默认值为0，即混音文件从起始混入源音视频。 |
|                | 混音文件截取时长     | `/amixDuration/<AmixDuration>`                    | N    | 1、用于混音文件长度截取；2、混音文件截取的时长，单位为秒，精确到毫秒;3、默认为目标混音文件音轨原始长度，即全部混入源音视频。 |
| 音频替换       | 替换文件             | `/multiArep/<MultiAudioReplaceURL>`               | N    | 用于替换原视频音频的音频文件。备注：不支持与音频混音同时使用。 |
|                | 开始替换时间         | `/multiArepOffset/<MultiAudioReplaceOffset>`      | N    | 音频替换起始位置，相对于原视频音频起始位置计算，单位为秒，精确到毫秒，默认取0 |
|                | 替换文件截取开始时间 | `/multiArepStart/<MultiAudioReplaceStart>`        | N    | 1、用于替换文件长度截取；2、替换文件截取的开始时间，单位为秒，精确到毫秒；3、默认值为0，即替换文件从起始混入源音视频。 |
|                | 替换文件截取时长     | `/multiArepDuration /<MultiAudioReplaceDuration>` | N    | 目标音频文件截取的时长，单位为秒，精确到毫秒，默认为目标音频文件音轨原始长度，即全部目标音频替换原视频音频。 |
| 音频质量       | 音频质量             | `/aq/<AudioQuality>`                              | N    | 1、音频质量，取值范围为0-9（mp3），10-500（aac），10-500（aac_he)；，仅支持mp3和aac，值越小，码率越高。2、不能与音频码率参数共用。 |
| 音频音量       | 音频音量             | `/volume/<Volume>`                                | N    | 1、调整音频音量为原音频音量的倍数, 精确到小数点后2位 ，默认值为 1.0, 范围 [0.01, 3]；2、不可与【音频响度标准化】共用。 |
| 音频响度标准化 | 音频整体响度值       | `/loudnormI/<LoudNormI>`                          | N    | 音频整体响度值，当 loudnorm 为1时有效，取值范围 [-70.0, -5.0], 默认为 -24.0 |
| 音频响度标准化 | 音频响度范围         | `/loudnormLRA/<LoudNormLRA>`                      | N    | 音频响度范围，当 loudnorm 为1时有效， 取值范围 [1.0, 20.0], 默认为 7.0 |
| 音频响度标准化 | 音频最高峰值         | `/loudnormTP/<LoudNormTP>`                        | N    | 音频最高峰值，当 loudnorm 为1时有效， 取值范围 [-9.0, 0.0], 默认为 -2.0 |

#### **4. 字幕编辑**

| 中文名   | 参数名称                  | 必填 | 说明                                                         |
| -------- | ------------------------- | ---- | ------------------------------------------------------------ |
| 禁用字幕 | `/sn/<SubtitleNo>`        | N    | 是否去除字幕，0为保留，1为去除。默认值为0。                  |
| 添加字幕 | `/subtitle/<SubtitleURL>` | N    | 添加字幕，支持：srt格式字幕（uft-8编码和和utf-8 BOM编码）、带有字幕的mkv文件、embed（将原视频的字幕流嵌入目标视频）。基于base64编码。 |