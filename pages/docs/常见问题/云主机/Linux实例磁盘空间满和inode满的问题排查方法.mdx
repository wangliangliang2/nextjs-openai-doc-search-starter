<blockquote><p><strong data-spm-anchor-id="a2c9r.12641768.0.i1.66f25e3b6f5XX7">免责声明：</strong>本文可能由社区贡献或涉及第三方产品信息，建议您访问社区或第三方产品的官方网站获取帮助与支持。第三方产品不在七牛云售后支持范围。本文仅供参考，七牛云不做任何暗示或其他形式的承诺。</p></blockquote><h1 font-weigh = "bold" id="h2-u95EEu9898u63CFu8FF01">问题描述</h1><p data-spm-anchor-id="a2c9r.12641768.0.i4.3c80HRPjHRPjfm">在Linux系统的云服务器QVM实例内创建文件时，出现类似如下空间不足的提示。</p><pre>No space left on device …</pre><h1 font-weigh = "bold" id="h2-u95EEu9898u539Fu56E02">问题原因</h1><p data-spm-anchor-id="a2c9r.12641768.0.i5.3c80HRPjHRPjfm">导致该问题的可能原因如下所示：</p><ul><li>磁盘分区空间使用率达到百分之百。</li><li>磁盘分区inode使用率达到百分之百。</li><li>存在僵尸文件。<blockquote><strong>说明</strong>：已删除文件因句柄被占用未释放，导致相应空间未释放的文件。</blockquote></li><li>挂载点覆盖。<blockquote><strong>说明</strong>：在原有文件系统的相应目录下已经存在大量文件。挂载新磁盘后，导致使用<code>df</code>命令能统计到相关空间使用，而使用<code>su</code>命令统计不到。</blockquote></li></ul><h1 font-weigh = "bold" id="AywdZ">解决方案</h1><blockquote><p data-spm-anchor-id="a2c9r.12641779.0.i0.1badSS8aSS8aLc">七牛云提醒您：</p><ul><li>如果您对实例或数据有修改、变更等风险操作，务必注意实例的容灾、容错能力，确保数据安全。</li><li data-spm-anchor-id="a2c9r.12641779.0.i0.b170EQFdEQFdJ5">如果您对实例（包括但不限于QVM、RDS）等进行配置与数据修改，建议提前创建快照或开启RDS日志备份等功能。</li><li data-spm-anchor-id="a2c9r.12641779.0.i2.1badSS8aSS8aLc">如果您在七牛云平台授权或者提交过登录账号、密码等安全信息，建议您及时修改。</li></ul></blockquote><p data-spm-anchor-id="a2c9r.12641768.0.i6.1d6cjQhejQheux">要解决该问题，请根据不同的问题原因，通过以下方式进行处理：</p><ul><li><a class="from-extensions-error" href="#adPCB">分区容量满</a></li><li><a class="from-extensions-error" href="#ejmcJ">inode容量满</a></li><li><a class="from-extensions-error" href="#jQPCQ">修改inode数量</a></li><li><a class="from-extensions-error" href="#HNddz">僵尸文件分析删除</a></li><li><a class="from-extensions-error" href="#h3-u6302u8F7Du70B9u8986u76D6">挂载点覆盖</a></li></ul><h2 font-weigh = "bold" id="adPCB" data-spm-anchor-id="a2c9r.12641768.0.i8.3c80HRPjHRPjfm">分区容量满的处理</h2><ol style="font-weight: 400;"><li>登录服务器，使用<code>df -h</code>命令查看磁盘使用率，其中的<strong>Mounted on</strong>指挂载的目录。<br><img src="http://qey2kbifv.hn-bkt.clouddn.com/2020-08-13/bncGLDuIEAF6ogOdJv1Y.png"></li><li>进入根目录，执行以下指令，逐级查看哪个目录占用磁盘空间较大，进入相应的目录，直到找到最精确的的文件或目录。<br><pre data-spm-anchor-id="a2c9r.12641768.0.i14.3c80HRPjHRPjfm">du -sh *</pre>系统显示类似如下。<br><img src="http://qey2kbifv.hn-bkt.clouddn.com/2020-08-13/uxJbs8e24d5WmKIC3ghH.png"></li><li>最后，结合业务情况等判断对相关文件或目录进行删除，或者购买更大的数据盘分担处理。</li></ol><h2 font-weigh = "bold" id="ejmcJ">inode容量满的处理</h2><p style="font-weight: 400;">通过如下操作，解决inode容量满的问题。</p><h3 font-weigh = "bold" id="Cskww" style="font-weight: 400;"><strong>查询inode使用情况</strong></h3><p style="font-weight: 400;">Linux的inode节点中，记录了文件的类型、大小、权限、所有者、文件连接的数目、创建时间与更新时间等重要的信息，还有一个比较重要的内容就是指向数据块的指针。一般情况不需要特殊配置，如果存放文件很多，则需要配置。有时磁盘空间有剩余但是不能存放文件，可能是由于inode耗尽所致。</p><ol style="font-weight: 400;"><li>执行<code>df -i</code>命令，可以查询inode的使用情况。<br><img src="http://qey2kbifv.hn-bkt.clouddn.com/2020-08-13/JGalyStKnEzdkpQjAOrM.png"></li><li>如果inode使用率达到或者接近100%，可以通过以下两种方式进行处理：<ul><li><a class="from-extensions-error" href="#trBFk">清除inode占用高的文件或者目录</a>。</li><li><a class="from-extensions-error" href="#jQPCQ">修改inode数量</a>。</li></ul></li></ol><h3 font-weigh = "bold" id="trBFk" style="font-weight: 400;"><strong>清除inode占用高的文件或者目录</strong></h3><p style="font-weight: 400;">如果不方便格式化磁盘以增加inode数量，可以参考以下步骤，清理inode占用量高的文件或者目录。</p><ol style="font-weight: 400;"><li>登录服务器，执行以下命令，分析根目录下的每个二级目录下有多少个文件。<pre>for i in /*; do echo $i; find $i | wc -l; done</pre>系统显示类似如下。<br><img src="http://qey2kbifv.hn-bkt.clouddn.com/2020-08-13/7WXuMvHgUmiLRDnFQN9K.png"></li><li>然后，逐层进入inode占用最高的目录，继续执行上述指令，逐步定位占用过高空间的文件或目录，最后进行相应清理。</li></ol><h3 font-weigh = "bold" id="jQPCQ" style="font-weight: 400;"><strong>修改inode数量</strong></h3><p style="font-weight: 400;">如果不允许清理磁盘中的文件，或者清理后inode使用率仍然较高，则需要通过以下步骤，增加inode节点数量。</p><blockquote><p style="font-weight: 400;"><strong>说明</strong>：inode的调整需要重新格式化磁盘，请确保数据已经得到有效备份后，再进行以下操作。</p></blockquote><ol style="font-weight: 400;"><li>执行以下命令，卸载系统文件。<pre>umount /home</pre></li><li>执行以下命令，重新建立文件系统，指定inode节点数。<pre>mkfs.ext3 /dev/xvdb -N 1638400</pre><blockquote><strong>说明</strong>：本文指定inode节点数1638400，现场实际环境请以实际为准。</blockquote></li><li>执行以下命令，修改fstab文件。<pre>vim /etc/fstab</pre></li><li>执行以下命令，查看修改后的inode节点数。<pre>dumpe2fs -h /dev/xvdb | grep node</pre>系统显示类似如下。<br><img src="http://qey2kbifv.hn-bkt.clouddn.com/2020-08-13/C09oQl4GSpKzjkyF5X8d.png"></li></ol><h2 font-weigh = "bold" id="HNddz" data-spm-anchor-id="a2c9r.12641768.0.i2.3c807uRk7uRkXU">僵尸文件分析与删除</h2><p style="font-weight: 400;">如果磁盘和inode都没有问题，则需要查看是否存在未被清除句柄的僵尸文件。这些文件实际上已经被删除，但是有服务程序在使用这些文件，导致这些文件一直被占用，无法释放磁盘空间。如果这些文件过多，会占用很大的磁盘空间。参考以下步骤查看并删除僵尸文件。</p><ol><li style="font-weight: 400;"><a>远程登录</a>服务器。</li><li style="font-weight: 400;">执行以下命令，安装lsof。<pre>yum install lsof&nbsp;-y</pre></li><li style="font-weight: 400;">执行以下命令，查看僵尸文件占用情况。<pre>lsof |grep delete | more</pre>系统显示类似如下。<br><img style="letter-spacing: 0.05em;" src="http://qey2kbifv.hn-bkt.clouddn.com/2020-08-13/TYZ61RIoVCAxKEwF98li.png"></li><li style="font-weight: 400;">如果僵尸文件过多，会占用很大的磁盘空间。可以通过以下方法释放句柄，以清除僵尸文件。<ol><li style="font-weight: 400;">重启服务器，验证效果。重启服务器，系统会退出现有的进程，开机后重新加载。该过程会释放调用的deleted文件的句柄。</li><li style="font-weight: 400;">根据<code>lsof</code>命令列出的pid进程号，使用<code>kill</code>命令正常停止或结束占用这些文件的服务进程。<blockquote><strong>说明</strong>：如果服务器正在运行业务，可能会影响到业务，请慎重操作。</blockquote></li></ol></li></ol><h2 font-weigh = "bold" id="h3-u6302u8F7Du70B9u8986u76D6">挂载点覆盖</h2><p>先取消磁盘挂载，再检查原挂载目录下的空间占用情况。</p><h1 font-weigh = "bold" id="tbkGx" data-spm-anchor-id="a2c9r.12641768.0.i8.3c807uRk7uRkXU">适用于</h1><ul><li>云服务器 QVM</li></ul><p>&nbsp;</p><div class="website-filter" data-website="cn"><p>如果您的问题仍未解决，您可以<a rel="noopener noreferrer" target="_blank" href="https://support.qiniu.com/tickets/new/?ref=developer.qiniu.com">提交工单</a>联系七牛云技术支持。</p></div>  </div>              	