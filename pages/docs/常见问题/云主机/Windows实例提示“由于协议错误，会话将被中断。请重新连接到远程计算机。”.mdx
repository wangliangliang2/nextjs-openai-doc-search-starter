<div data-website="cn intl"><blockquote><p><strong>免责声明：</strong>本文档可能包含第三方产品信息，该信息仅供参考。七牛云对第三方产品的性能、可靠性以及操作可能带来的潜在影响，不做任何暗示或其他形式的承诺。</p></blockquote></div><h1 font-weigh = "bold" id="iAj6g" data-lake-id="7e5ee25ca606883aba99127ff75f24c8_h2_0">问题描述</h1><p>远程连接Windows系统的QVM实例时，提示协议错误。具体的报错如下：</p><pre>由于协议错误，会话将被中断。请重新连接到远程计算机。</pre><h1 font-weigh = "bold">问题原因</h1><p>可能导致该问题的部分原因如下：</p><ul><li>原因一<br>目标实例的远程会话配置错误。当远程会话配置错误，远程连接时会出现协议错误的提示。</li><li>原因二<br>目标实例的远程连接端口被其他应用占用。Windows系统默认远程桌面连接端口号为3389，当该端口被其他程序占用时，远程连接服务将无法正常运行。</li></ul><h1 font-weigh = "bold" id="DnnXc">解决方案</h1><blockquote><p data-spm-anchor-id="a2c9r.12641779.0.i0.1badSS8aSS8aLc">七牛云提醒您：</p><ul><li data-spm-anchor-id="a2c9r.12641768.0.i10.57bb5e3bmxozwF">如果您对实例或数据有修改、变更等风险操作，务必注意实例的容灾、容错能力，确保数据安全。</li><li data-spm-anchor-id="a2c9r.12641779.0.i0.b170EQFdEQFdJ5">如果您对实例（包括但不限于QVM、RDS）等进行配置与数据修改，建议提前创建快照或开启RDS日志备份等功能。</li><li data-spm-anchor-id="a2c9r.12641779.0.i2.1badSS8aSS8aLc">如果您在七牛云平台授权或者提交过登录账号、密码等安全信息，建议您及时修改。</li></ul></blockquote><p>不同问题原因对应的解决方案不同，您可以根据现场实际情况选择对应的问题原因及解决方案。</p><blockquote><p><strong>说明</strong>：本文中的操作步骤以Windows Server 2016版本为例。</p></blockquote><h2 font-weigh = "bold" id="rQpMc">原因一：目标实例的远程会话配置错误</h2><p>处理步骤如下：</p><ol><li data-spm-anchor-id="a2c9r.12641768.0.i0.3dac77dx77dx5A"><a data-spm-anchor-id="a2c9r.12641768.0.0" href="/document_detail/108451.html">使用VNC登录</a>Windows实例。</li><li>单击<strong>开始</strong>，输入<code>gpedit.msc</code>。单击<strong>Enter</strong>按钮，打开<strong>本地组策略编辑器</strong>。</li><li>在<strong>本地组策略编辑器</strong>窗口中，依次单击<strong>计算机配置</strong>&gt;<strong>管理模板</strong>&gt;<strong>Windows 组件</strong>&gt;<strong>远程桌面服务</strong>&gt;<strong>远程桌面会话主机</strong>&gt;<strong>安全</strong><span style="letter-spacing: 0.7px;"><strong>计算机配置</strong>。</span></li><li>在<strong>安全</strong>目录中，双击<strong data-spm-anchor-id="a2c9r.12641768.0.i4.2dd9n1bYn1bYGV">远程（RDP）连接要求使用指定的安全层</strong>。<br><img src="http://qey2kbifv.hn-bkt.clouddn.com/2020-08-13/jn9MDUiYleoTGWtdZLRu.png" width="540"></li><li>选择<strong>已启用</strong> ，在<strong>安全层</strong>选项中选择<strong>RDP</strong>，单击<strong>确定</strong>。<br><img src="http://qey2kbifv.hn-bkt.clouddn.com/2020-08-13/iG4QDkpjb1NLyCzhcsSu.png" width="540"></li><li>单击<strong>开始</strong>，输入<code>cmd</code>，单击<strong>Enter</strong>按钮，打开命令行。</li><li>执行以下命令，完成策略更新，使以上的设置生效。<pre>gpupdate</pre>系统显示如下图，计算机策略更新完成。<br><img src="http://qey2kbifv.hn-bkt.clouddn.com/2020-08-13/RaH74JnhmTPgrXw6lk3Z.png" alt="" width="340" height=""></li><li>重试远程连接，确认问题已经修复。</li></ol><h2 font-weigh = "bold" id="ZzXSC">原因二：目标实例的远程连接端口被其他应用占用</h2><div class="msg-bubble other-msg"><div class="msg-content-wrapper"><div class="msg-content scaleable"><div class="msg-text normal-text"><div class="origin-content">如果目标实例的远程连接端口被其他应用占用，您可以从下列两种解决方案中选择其一。</div></div></div></div></div><h3 font-weigh = "bold" id="kNjdT">方案一：修改远程连接端口号</h3><p>参考下列步骤，修改远程连接的端口号，然后使用新的端口号重试远程连接：</p><ol><li data-spm-anchor-id="a2c9r.12641768.0.i0.3dac77dx77dx5A"><a data-spm-anchor-id="a2c9r.12641768.0.0" href="/document_detail/108451.html">使用VNC登录</a>Windows实例。</li><li>单击<strong>开始</strong>，输入<code>regedit</code>，单击<strong>Enter</strong>按钮，打开<strong>注册表编辑器</strong>。</li><li>依次进入以下目录。<pre>HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp</pre></li><li>双击<strong>RDP-Tcp</strong>目录中名称为<strong>PortNumber</strong>的注册表项。<br><img src="http://qey2kbifv.hn-bkt.clouddn.com/2020-08-13/dW2w7RX6BNjObKt8yEou.png" width="540"><br><img src="http://qey2kbifv.hn-bkt.clouddn.com/2020-08-13/L8pxWZG9E50OB2iCT7zg.png" width="540"></li><li>在编辑页面，选择<strong>基数</strong>选项中的<strong>十进制</strong>，修改<strong>数值数据</strong>中的值，该值即为远程桌面使用的端口号。<br><blockquote><strong>说明</strong>：修改远程桌面默认端口时，请根据现场情况选择合适的TCP端口号。</blockquote><img src="http://qey2kbifv.hn-bkt.clouddn.com/2020-08-13/ohVuvyC1PqsAHwJLjmfp.png" width="340"><blockquote><strong>说明</strong>：图中的3389端口号为远程连接的默认端口号，仅作为示例。</blockquote></li><li>重启Windows系统或重启该QVM实例。</li></ol><h3 font-weigh = "bold" id="hcnJG">方案二：关闭占用远程连接端口的应用进程</h3><p>参考下列步骤，关闭正在占用远程连接端口的应用进程，以释放端口号，然后重试远程连接：</p><ol><li data-spm-anchor-id="a2c9r.12641768.0.i0.3dac77dx77dx5A"><a class="from-extensions-error" data-spm-anchor-id="a2c9r.12641768.0.0" href="/document_detail/108451.html">使用VNC登录</a>Windows实例。</li><li>单击<strong>开始</strong>，输入<code>cmd</code>，单击<strong>Enter</strong>按钮，打开命令行。</li><li>执行以下命令，获取占用远程连接端口的进程号（PID）。<pre>netstat -ano |findstr 3389</pre><blockquote><strong>说明</strong>：此处以远程连接默认端口号3389为例，现场需要以实际情况为准。</blockquote></li><li>执行以下命令，根据PID查看进程对应的应用程序。正常情况下，远程连接端口被svchost.exe进程占用。<pre>tasklist |findstr [$PID]</pre><blockquote><strong>说明</strong>：[$PID]指上一步获取的PID。</blockquote></li><li>如果远程连接端口被svchost.exe之外的进程占用，则表明远程连接端口的确被其他应用所占用。您可以执行以下命令，根据PID关闭指定的进程，释放被占用的远程连接端口。<blockquote><strong>警告</strong>：关闭进程属于风险操作，请确保关闭进程后不影响业务运行，方可执行此操作。</blockquote><pre>taskkill /f /pid [$PID]</pre></li></ol><h1 font-weigh = "bold" id="rDcKJ"><a id="适用于" class="from-extensions-error" href="#适用于"></a>适用于</h1><ul><li>云服务器QVM</li></ul><div class="website-filter" data-website="cn"><p>如果您的问题仍未解决，您可以<a rel="noopener noreferrer" target="_blank" href="https://support.qiniu.com/tickets/new/?ref=developer.qiniu.com">提交工单</a>联系七牛云技术支持。</p></div>  </div>              	