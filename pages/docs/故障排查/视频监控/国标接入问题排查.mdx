# 设备注册失败/离线, 通道数量为0等问题
1. 本条建议`很很很很很`关键,设备网络设置成`自动获取IP`。以海康为例,登入设备的配置界面, 在`网络->基本设置->Tcp/Ip->勾选自动获取`。 
2. `路由器`问题，某社区1500个摄像头，每天固定时间集体离线后并无法恢复；排查后是路由器定时重启造成的, 路由器重启后, 设备的gb28181 udp数据报被路由器莫名丢弃了，无法与外部通信；解决办法，1. `关闭`路由器定时重启 2. 重启摄像头或者NVR。
3. 设备网络如果是定向流量卡, 发出的网络数据都被运营商屏蔽,需要联系运营商添加IP白名单。 
4. 检查摄像头/NVR所处的网络，是否能够连通SIP服务器的IP跟端口。
5. 检查摄像头/NVR的置国标配置页面，查看SIP服务器ID、SIP服务器IP和端口是否正确，是否为七牛云QVS提供的SIP服务器ID、IP和端口。
7. 是否配置了SIP域，如果配置了请确保SIP域为SIP服务器ID的前10位数字。
8. 检查是否正确配置,七牛云QVS设备管理中的设备国标ID。`宇视设备在“国标本地设置”选项卡中，SIP服务器编码是设备国标ID，而非SIP服务器ID。`
9. 设备的名称或者通道编号，含有特殊字符，`空格`等，会导致无法解析，而导致异常。
10. `视频通道ID`是空的，或者配置错误,NVR请参考[NVR接入最佳实践](https://developer.qiniu.io/qvs/7451/nvr-gb-access-process), 普通摄像头请参考[摄像头接入最佳实践](https://developer.qiniu.com/qvs/7448/gb-access-process)。
11. 个别摄像头或者NVR,设备固件存在bug, Catalog信令返回数量为0或没有应答Catalog, 如果确认配置正确的情况下,请反馈给设备厂商,升级国标固件。
12. 假如以上无果，`重启设备`，观察能否成功在线。

# 为什么设备是在线的，流是离线的？
* **先来了解，什么是设备状态，什么是流状态**
<img src="https://dn-odum9helk.qbox.me/FrhlPVQvSUfmdDZEMagXc9SpT0Lw" width = "600" height = "450" alt="gb28181视频设置" align=center />
<br>
* 如上图所述，当设备和“qvs信令服务”之间通过信令通道，存在周期性的保活心跳，设备就处于在线状态。<br>
* 信令通道传递的是文本字符，流量很小，qvs不收取流量费用。<br>
* 只有流媒体通道打开时，既设备开始推流时，才会产生上行的推流费用。<br>
* 设备状态和流状态是独立的2种状态。设备在线时，流离线有以下几种可能。
1.开启了按需拉流 
开启了按需拉流后，当视频流无人观看持续60s左右，会自动终止推流，此时流就显示离线。
开启按需拉流时，启动流的三种方式：
（1）portal上，“设备管理”界面下，实时预览中点击“启动拉流” 操作。
（2）通过[api触发](https://developer.qiniu.com/qvs/6907/start-device)摄像头推流。
（3）播放器触发播放请求。
（4）如果想保持视频流永远在线，可以关闭“按需拉流”。 操作如下,控制台界面中，“空间管理”-> 点击“配置”-> 空间信息，点击"编辑"-> 置灰"按需拉流"->点击 "确定"。则在此操作之后，视频流在下次重新推流时生效。
2. 如果以上都是正常的，依然无法拉流播放，请参考下面的片段[视频流卡顿，黑屏，无法观看等问题定位](#视频流卡顿，黑屏，无法观看等问题定位 "")。


# 视频流卡顿，画面异常，中断，首开慢等问题定位
如果是通过摄像头接入qvs的情况下，登录到摄像头的视音频参数配置界面；如果是通过NVR接入，或者摄像头被挂载到一个NVR下面时，则需要登录至NVR中修改相应参数。
1. 由于暂不支持H.265视频在web中预览，设备接入后,可在视频参数配置页面，修改成H.264。
2. 视频分辨率和帧率根据自身需求选择，若在同一网络下接入设备较多的情况下，可选择低分辨率，从1080p降低为720p，甚至更低的分辨率。
3. `最最重要的选项，码流控制/码率类型，选择 “可变码率”，等同于英文简写VBR。`
4. 在视频配置界面里，帧率设置有些设备默认是全帧率，帧率需调整为15，I帧间隔 = "视频帧率" * 2，即30。
4. 码流上限，分辨率720P时选择1024；分辨率为1080p时选择2048；也可以根据实际视频效果在调整。
5. 如果不需要在web浏览器中预览，也可以选择h265，此时需要使用[七牛的播放器SDK](https://developer.qiniu.com/qvs/7924/play-the-sdk)或者自行去第三方播放器(例如vlc，ffplay等)进行实时播放。综上视频异常建配置如下图：
分辨率720p的建议配置
<img src="https://dn-odum9helk.qbox.me/Fl-mFjONAWpXH5jOdAmwBAGJvm9U" width = "450" height = "300" alt="gb28181视频设置" align=center />
分辨率1080p的建议配置
<img src="https://dn-odum9helk.qbox.me/FuWma0CFM8BtQhJ2DbvkG30qL6CM" width = "450" height = "300" alt="gb28181视频设置" align=center /> 
<br>
6. 有些设备对gb28181存在兼容性问题.最典型的是设备通过gb28181推流时, 实际携带的ssrc(视频流的身份证)，与平台告诉设备的ssrc不一致，此时平台会拦截非法的视频流，导致无法观看。解决办法，尝试升级固件，如果还是解决不了，可提交工单，等待七牛进一步确认，如果确认是设备bug，我们会提供设备bug证据，客户可携带证据联系硬件设备厂商，修复设备上的bug。
7. 确认设备所在网络是否有防火墙，防火墙是否开启了入口的限制。
8. 有的设备只支持`tcp`或者`udp`拉流，在设备的`基本信息`页面，切换流传输模式，如果当前为`tcp`,则切换为`udp`;如果当前为`udp`, 则切换为`tcp`。一般可拉流成功。
9. 如果以上都尝试过，仍无法解决，请提[工单](https://support.qiniu.com/tickets/new/?space=%E8%A7%86%E9%A2%91%E7%9B%91%E6%8E%A7)或者在技术支持群里提问。


# 预览界面声音异常或无声
1. 首先确保设备有音频输入。
**说明：**
1.通过国标gb28181传输的音频，音频编码优先配置`g711alaw`, 采样率优先选择`8000`, 没有g711alaw的情况下, 选择aac + 8000采样率。
<img src="https://dn-odum9helk.qbox.me/Fo-AjhyR6-ssR_GkXHORglOt5Yo0" width = "450" height = "300" alt="gb28181音频设置" align=center />
2. gb28181接入的设备，在存在音频输入的条件下，标准规范是：视频和音频 （h264 + g711或者aac）要封装到ps包里发出(主流的海康，大华，宇视等都是这种标准音频打包方式。个别硬件厂商，会单独把音频包通过RTP包发出，这种格式不符合gb28181规范)，如果不是这种方式，则无法播放音频，如果不确定，可以跟摄像头供应商确认。
